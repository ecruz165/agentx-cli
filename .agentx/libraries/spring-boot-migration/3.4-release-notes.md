# Spring Boot 3.4 Release Notes

## Upgrading from Spring Boot 3.3

### RestClient and RestTemplate

Support for auto-configuring `RestClient` and `RestTemplate` to use Reactor Netty's `HttpClient` or the JDK's `HttpClient` has been added.
In order of precedence, the supported clients are now:

- Apache HTTP Components (`HttpComponentsClientHttpRequestFactory`)
- Jetty Client (`JettyClientHttpRequestFactory`)
- Reactor Netty `HttpClient` (`ReactorClientHttpRequestFactory`)
- JDK `HttpClient` (`JdkClientHttpRequestFactory`)
- Simple JDK `HttpURLConnection` (`SimpleClientHttpRequestFactory`)

Notably, if you don't have an HTTP client library on the classpath, this will likely result in the use of `JdkClientHttpRequestFactory` where `SimpleClientHttpRequestFactory` would have been used previously.
A particular client can be selected by setting `spring.http.client.factory`.
Supported values are `http-components`, `jetty`, `reactor`, `jdk`, and `simple`.

All five clients will follow redirects by default.
To disable this behavior, set `spring.http.client.redirects` to `dont-follow`.

### Apache HTTP Components and Envoy

Apache HTTP Components have changed defaults in the `HttpClient` relating to HTTP/1.1 TLS upgrades.
Most proxy servers handle upgrades without issue, however, you may encounter issues with Envoy or Istio.

If you need to restore previous behaviour, you can use the new `ClientHttpRequestFactoryBuilder`.
Define a `HttpComponentsClientHttpRequestFactoryBuilder` and apply the following customization:

```java
@Bean
public HttpComponentsClientHttpRequestFactoryBuilder httpComponentsClientHttpRequestFactoryBuilder() {
    return ClientHttpRequestFactoryBuilder.httpComponents()
            .withDefaultRequestConfigCustomizer((builder) -> builder.setProtocolUpgradeEnabled(false));
}
```

### Bean Validation of Configuration Properties

Previously, when a `@ConfigurationProperties` class annotated with `@Validated` was being validated using a Bean Validation implementation such as Hibernate Validator, validation of nested properties would be performed as they were bound, irrespective of the use of `@Valid`.
In Spring Boot 3.4, validation now follows the behavior of the Bean Validation specification.
Validation is performed from the `@ConfigurationProperties`-annoated class and only cascades down to nested properties where the corresponding field is annotated with `@Valid`.

When upgrading, inspect your `@ConfigurationProperties` classes with Bean Validation constraints.
Add `@Valid` as necessary where you want the validation to cascade down to nested properties.

### Bean-based Conditions

The behavior of `@ConditionalOnBean` and `@ConditionalOnMissingBean` has changed when used on a `@Bean` method and the `annotation` attribute is set.
As before, both conditions will use the return type of the `@Bean` method as a default for the type to match.
Previously, this default was not used if `name`, `type`, or `value` had been set.
As of Spring Boot 3.4, this default will also not be used if `annotation` has been set.
To restore the previous behavior, specify both a `value` that is the return type of the `@Bean` method and `annotation`.

### Graceful Shutdown

Graceful shutdown of the embedded web server (Jetty, Rector Netty, Tomcat, or Undertow) is now enabled by default.
If you need to restore the previous behavior, set `server.shutdown` to `immediate`.

### Paketo tiny Builder for Building OCI Images

The default Cloud Native Buildpacks builder used when building OCI images for JVM applications using the Maven `spring-boot:build-image` goal or Gradle `bootBuildImage` task has changed from `paketobuildpacks/builder-jammy-base` to `paketobuildpacks/builder-jammy-java-tiny`.
This should result in smaller images.
The `tiny` builder does not include a shell, so it might not work for applications that require a start script to run the application.

### Dynamic Properties with Testcontainers

Support for defining dynamic properties by injecting a `DynamicPropertyRegistry` into a `@Bean` method has been deprecated and attempting to do so will now fail by default.
Instead of injecting `DynamicPropertyRegistry` in a `@Bean` method, implement a separate `@Bean` method that returns a `DynamicPropertyRegistrar`.

If you wish to continue injecting `DynamicPropertyRegistry`, set `spring.testcontainers.dynamic-property-registry-injection` to either `warn` or `allow`.

### @AutoConfigureTestDatabase with Containers

The `@AutoConfigureTestDatabase` annotation now attempts to detect if a database has been sourced from a container.
This should remove the need to add `replace=Replace.NONE` if you want to use the annotation with container databases.

If you need to revert to the old behavior, set `replace=Replace.AUTO_CONFIGURED` on the annotation.

### Controlling Access to Actuator Endpoints

Support for enabling and disabling endpoints has been reworked, replacing the on/off support that it provided with a finer-grained access model.
The new model supports only allowing `read-only` access to endpoint operations, in addition to disabling an endpoint (access of `none`) and fully enabling it (access of `unrestricted`).

The following properties have been deprecated:

- `management.endpoints.enabled-by-default`
- `management.endpoint.<id>.enabled`

Their replacements are:

- `management.endpoints.access.default`
- `management.endpoint.<id>.access`

Similarly, the `enableByDefault` attribute on `@Endpoint` has been deprecated with a new `defaultAccess` attribute replacing it.

### HtmlUnit 4.5

HtmlUnit has been upgraded to 4.5.
With this upgrade comes a change in dependency coordinates from `net.sourceforge.htmlunit:htmlunit` to `org.htmlunit:htmlunit` and a change in package names from `com.gargoylesoftware.htmlunit.*` to `org.htmlunit.*`.
When upgrading, update your build configuration and imports accordingly.

### Selenium HtmlUnit 4.25

Selenium HtmlUnit has been updated to 4.25.
With this upgrade comes a change in dependency coordinates from `org.seleniumhq.selenium:htmlunit-driver` to `org.seleniumhq.selenium:htmlunit3-driver`.
When upgrading, update your build configuration accordingly.

### WebJars Locator Integration

For faster startup times and efficient WebJars asset resolution, you will need to update your pom.xml/build.gradle to depend on `org.webjars:webjars-locator-lite` instead of `org.webjars:webjars-locator-core` (both dependencies are managed by Spring Boot).
Note that `org.webjars:webjars-locator-core` support in Spring is now deprecated and will be removed in a future version.

### OkHttp Dependency Management Removed

Spring Boot no longer depends on OkHttp so it no longer manages its version.
If your application has OkHttp dependencies, update its build to use an OkHttp version that meets its needs.

### Deprecation of @MockBean and @SpyBean

`@MockBean` and `@SpyBean` have been deprecated in favor of `@MockitoBean` and `@MockitoSpyBean` in Spring Framework.
The functionality provided by the Spring Framework annotations is not exactly the same as that offered by Spring Boot.
For example, `@MockitoBean` is not supported on `@Configuration` classes and you may need to migrate to annotating fields on a test class instead.

### Tomcat APR

If you're using Tomcat's APR and you're running on Java >= 24, you have to set the property `server.tomcat.use-apr` to `when-available` or `always`. This property has been introduced with Spring Boot 3.4.4 and defaults on Java >= 24 to `never`. On Java < 24 this property defaults to `when-available`.

### Empty YAML Maps
Empty maps are now ignored when processing YAML configuration.
This allows all values in the `Environment` to be scalar, aligning YAML configuration with other formats such as properties files and system properties.

### Deprecations from Spring Boot 3.2

Classes, methods, and properties that were deprecated in Spring Boot 3.2 and marked for removal in 3.4 have been removed in this release.
Please ensure that you aren't calling deprecated methods before upgrading.

### Minimum Requirements Changes

#### Gradle

Gradle 7.5, 8.0, 8.1, 8.2 and 8.3 are no longer supported.
Gradle 7.x (7.6.4 or later) or Gradle 8.x (8.4 or later) is now required.

## New and Noteworthy

> **Tip:** Check the configuration changelog for a complete overview of the changes in configuration.

### Structured Logging

Support for structured logging has been introduced with built-in support for Elastic Common Schema (`ecs`), Graylog Extended Log Format (`gelf`) and Logstash (`logstash`).
To enable structured file logging set `logging.structured.format.file` to `ecs`, `gelf` or `logstash`.
Similarly, to enable structured console logging set `logging.structured.format.console`.

### `@Fallback` Beans

`@ConditionalOnSingleCandidate` now supports `@Fallback` beans.
The condition will match if there's a single primary bean or, if there are no primary beans, if there's a single non-fallback bean.

### Defining Additional Beans

When type matching, bean-based conditions will now ignore any beans that are not default candidates.
By declaring that a bean is not a default candidate (using `@Bean(defaultCandidate=false)`), a bean of an auto-configured type can now be defined without causing the auto-configure bean of the same type to back off.

### ClientHttpRequestFactory Builders

A new `ClientHttpRequestFactoryBuilder` interface has been added which allows you to build `ClientHttpRequestFactory` instances for specific technologies.
Builders allow for fine-grained customization of the underlying components, as well as a consistent way to apply common settings.

The following builders can be created for specific libraries using static factory methods from the interface:

- Apache HTTP Components (`ClientHttpRequestFactoryBuilder.httpComponents()`)
- Jetty Client (`ClientHttpRequestFactoryBuilder.jetty()`)
- Reactor Netty `HttpClient` (`ClientHttpRequestFactoryBuilder.reactor()`)
- JDK `HttpClient` (`ClientHttpRequestFactoryBuilder.jdk()`)
- Simple JDK `HttpURLConnection` (`ClientHttpRequestFactoryBuilder.simple()`)

### Observability Improvements

#### Application Groups

The new `spring.application.group` property can be used to group applications together, for example if they all belong to some business unit or one bigger application arrangement.
When this property is set, it's also included in the log messages.
This behavior can be controlled with the property `logging.include-application.group`.
The application group is also automatically added to the OpenTelemetry `Resource`.

#### OTLP
It's now possible to send OTLP spans over the gRPC transport.
For this, set the new configuration property `management.otlp.tracing.transport` to `grpc`.
This property defaults to `http`.

The new properties under `management.otlp.logs` can be used to auto-configure OpenTelemetry's `OtlpHttpLogRecordExporter` and `SdkLoggerProvider`.

#### Other Observability Updates

The `ProcessInfoContributor` now also shows memory info about heap and non-heap usage.

New `management.otlp.tracing.export.enabled`, `management.wavefront.tracing.export.enabled` and `management.zipkin.tracing.export.enabled` properties can now be used to enable or disable trace exporting more finely grained.

### AssertJ Support for MockMvc

Auto-configuration for `MockMvcTester` is provided when AssertJ is on the classpath.
`MockMvcTester` lets you define the requests and the assertions using a fluent API.
It can be injected anywhere `MockMvc` is.

### Spring Pulsar

Configuration properties are now provided for configuring a default tenant and namespace.
The defaults apply when consuming or producing messages with a topic URL that is not fully qualified.
Configure them using the `spring.pulsar.defaults.topic.tenant` and `spring.pulsar.defaults.topic.namespace` configuration properties or define your own `PulsarTopicBuilder` bean.

A new `PulsarContainerFactoryCustomizer` interface has been added to support customization of the auto-configured `PulsarContainerFactory`.

Two new configuration properties for configuring the Pulsar client's concurrency have been introduced:

- `spring.pulsar.client.threads.io` controls the number of threads to be used for handling connections to brokers.
- `spring.pulsar.client.threads.listener` controls the number of threads to be used for message listeners.

### Couchbase Authentication

Client certificates can now be used to authenticate with a Couchbase cluster, as an alternative to basic username and password authentication.

### FreeMarker

FreeMarker variables that are used by the auto-configured FreeMarker's `Configuration` object can now be customized.
To do so, define one or more beans of type `FreeMarkerVariablesCustomizer`.

### Embedded Broker support with ActiveMQ Classic

Now that ActiveMQ Classic supports an embedded broker again, the auto-configuration has been updated to support it.

Note that contrary to Spring Boot 2.7.x, the ActiveMQ starter is client only. To use the embedded broker, `org.apache.activemq:activemq-broker` should be added to your application.

### Configuration Metadata

The default value of an `Enum` is now detected by the annotation processor.
If you have added manual metadata to provide the value for a custom property, make sure to remove it.

### Docker Compose Improvements

Docker Compose now supports multiple Docker Compose configuration files.

#### Command Line Arguments

The new properties `spring.docker.compose.start.arguments` and `spring.docker.compose.stop.arguments` can be used to specify additional command line arguments that are passed to the Docker Compose subcommands when starting and stopping services.

#### Updated Support

- Postgres `POSTGRES_HOST_AUTH_METHOD=trust` environment variable is now supported.
- Support for Redis Stack and Redis Stack Server has been added using the `redis/redis-stack` and `redis/redis-stack-server` container images respectively.
- Support for Grafana LGTM has been added using the `grafana/otel-lgtm` container image.
- Support has been added for Hazelcast (using `HazelcastConnectionDetails`).
- Support has been added for OTLP logging.

### Testcontainers Improvements

- Support has been added for `org.testcontainers.kafka.KafkaContainer`.
- Support for Redis Stack and Redis Stack Server has been added using the `redis/redis-stack` and `redis/redis-stack-server` container images respectively.
- Support has been added for `org.testcontainers.grafana.LgtmStackContainer`.
- Support has been added for Hazelcast (using `HazelcastConnectionDetails`).
- Support has been added for OTLP logging.
- Support for `RedisContainer` has been added

### Actuator

#### Pluggable Actuator Exposers

It is now possible to extend Spring Boot to expose actuator endpoints in a pluggable way.
The new `EndpointExposureOutcomeContributor` interface can be implemented to influence `@ConditionalOnAvailableEndpoint` conditions.

#### SSL information and health check

If you're using SSL bundles, there's now a new endpoint showing SSL information (validity dates, issuer, subject, etc.) available under `/actuator/info`.
This endpoint also shows soon to be expired certificates to alert you that they need to be rotated soon.
There's a new configuration property named `management.health.ssl.certificate-validity-warning-threshold` to configure the threshold.

A new health check monitoring the SSL certificates has been added, too. If a certificate is invalid, it sets the status to `OUT_OF_SERVICE`.

#### Additional info in `/actuator/scheduledtasks` endpoints

The `/scheduledtasks` Actuator endpoint now exposes additional metadata about scheduled tasks, such as "next scheduled execution time" and "last execution time, status and exception".

### Dependency Upgrades
Spring Boot 3.4 moves to new versions of several Spring projects:

* Spring AMQP 3.2
* Spring Authorization Server 1.4
* Spring Batch 5.2
* Spring Data 2024.1
* Spring Framework 6.2
* Spring HATEOAS 2.4
* Spring Integration 6.4
* Spring Kafka 3.3
* Spring Pulsar 1.2
* Spring Security 6.4
* Spring Session 3.4

Numerous third-party dependencies have also been updated, some of the more noteworthy of which are the following:

* Apache Http Client 5.4
* AssertJ 3.26
* Artemis 2.37
* Elasticsearch Client 8.15
* Flyway 10.20
* Gson 2.11
* Hibernate 6.6
* HtmlUnit 4.5
* JUnit Jupiter 5.11
* Jackson 2.18.0
* Jedis 5.2
* Kafka 3.8
* Lettuce 6.4
* Liquibase 4.29
* Log4j 2.24
* MariaDB 3.4
* Micrometer 1.14
* Micrometer Tracing 1.4
* Mockito 5.13
* MongoDB 5.2.0
* MySQL 9.1
* OpenTelemetry 1.41
* Oracle Database 23.4
* R2DBC MySQL 1.3
* Rabbit AMQP Client 5.22
* Rabbit Stream Client 0.18.0
* Reactor 2024.0
* Selenium 4.25
* Testcontainers 1.20.3
* XMLUnit 2.10

## Deprecations in Spring Boot 3.4

* `spring.gson.lenient` in favor of `spring.gson.strictness`.
* `@MockBean` and `@SpyBean` in favor of Spring Framework's `@MockitoBean` and `MockitoSpyBean` respectively.
* `management.endpoints.enabled-by-default` and `management.endpoint.<id>.enabled` in favor of `management.endpoints.access.default` and `management.endpoint.<id>.access` respectively
* `enableByDefault` on `@Endpoint` in favor of `defaultAccess`
